<aura:component controller="DocumentTemplatePreviewController" description="DocumentTemplatePreview"
                implements="flexipage:availableForAllPageTypes,force:hasRecordId">
  <aura:attribute name="recordId" type="String"/>
  <aura:attribute name="selectedTestRecord" type="Object"/>
  <aura:attribute name="testRecordOptions" type="List" default="[]"/>
  <aura:attribute name="previewUrl" type="String"/>
  <aura:attribute name="template" type="Object" default="{}"/>

  <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
  <aura:handler name="generateDocumentPreview" event="c:DocTempPreviewEvent" action="{!c.showTemplatePreview}"/>

  <lightning:card>
    <div class="card-title">
      <h2 class="slds-text-heading_small card-header">
        {!not(empty(v.selectedTestRecord)) ? 'Running preview for ' + v.selectedTestRecord.Name : 'Template Previewer'}
      </h2>
      <lightning:buttonIcon onclick="{!c.resetPreview}"
                            iconName="utility:refresh"
                            size="small"
                            alternativeText="Start Over"
                            class="refresh-icon"/>
      <div class="slds-clear"></div>
    </div>

    <div class="card-container">
      <lightning:select aura:id="templateSelect"
                        label="Select a recently viewed record to preview:"
                        onchange="{!c.recordSelected}"
                        disabled="{!empty(v.testRecordOptions)}">
        <optgroup label="{!v.template.Salesforce_Object__c}">
          <aura:iteration items="{!v.testRecordOptions}" var="option">
            <option text="{!option.Name}" value="{!option.Id}" selected="{!option.selected}"></option>
          </aura:iteration>
        </optgroup>
      </lightning:select>
    </div>

    <aura:if isTrue="{!empty(v.testRecordOptions)}">
      <div class="loading-container">
        <h2 style="font-size:24px;">
          Loading...
        </h2>
      </div>
    </aura:if>

    <aura:if isTrue="{!and(not(empty(v.selectedTestRecord.Id)), empty(v.previewUrl))}">
      <c:DocumentGenerator recordId="{!v.selectedTestRecord.Id}"
                           sObjectName="{!v.template.Salesforce_Object__c}"
                           isTestMode="true"
                           inTemplatePreviewTestMode="true"
                           selectedDocumentTemplateId="{!v.recordId}"
                           isOneOff="true">
      </c:DocumentGenerator>
    </aura:if>

    <aura:if isTrue="{!not(empty(v.previewUrl))}">
      <iframe src="{!v.previewUrl}" style="width:100%;height:900px;border:none;margin-top:15px;"></iframe>
    </aura:if>
  </lightning:card>
</aura:component>